# üì± Integra√ß√£o WhatsApp - VoxStudent

Este documento explica como funciona a integra√ß√£o com WhatsApp no sistema VoxStudent, incluindo configura√ß√£o, autentica√ß√£o, envio de mensagens e funcionalidades de login via magic link.

## üìã √çndice

- [Vis√£o Geral](#vis√£o-geral)
- [Configura√ß√£o Inicial](#configura√ß√£o-inicial)
- [Autentica√ß√£o WhatsApp](#autentica√ß√£o-whatsapp)
- [Funcionalidades](#funcionalidades)
- [API Endpoints](#api-endpoints)
- [Banco de Dados](#banco-de-dados)
- [Sistema de Filas](#sistema-de-filas)
- [Rate Limiting](#rate-limiting)
- [Magic Link via WhatsApp](#magic-link-via-whatsapp)
- [Logs e Monitoramento](#logs-e-monitoramento)
- [Troubleshooting](#troubleshooting)

## üéØ Vis√£o Geral

A integra√ß√£o WhatsApp do VoxStudent utiliza a biblioteca `whatsapp-web.js` para conectar-se ao WhatsApp Web e enviar mensagens automatizadas. O sistema inclui:

- **Autentica√ß√£o via QR Code**: Conecta uma conta WhatsApp ao sistema
- **Envio de Mensagens**: Lembretes de aulas, confirma√ß√µes e notifica√ß√µes
- **Sistema de Filas**: Processamento ass√≠ncrono de mensagens
- **Rate Limiting**: Controle de frequ√™ncia de envio (padr√£o: 30 segundos)
- **Magic Link Login**: Login via WhatsApp para administradores
- **Logs Detalhados**: Monitoramento completo de atividades

## ‚öôÔ∏è Configura√ß√£o Inicial

### 1. Vari√°veis de Ambiente

Adicione as seguintes vari√°veis ao seu arquivo `.env`:

```env
# Configura√ß√£o de Telefones Autorizados para Magic Link
SUPER_ADMIN_PHONE="+5511999999999"  # Telefone do super administrador
ADMIN_PHONES="+5511888888888,+5511777777777"  # Telefones de administradores (separados por v√≠rgula)

# Configura√ß√£o da Aplica√ß√£o (j√° existentes)
NEXTAUTH_URL="http://localhost:3000"
JWT_SECRET="your-super-secret-jwt-key"
MAGIC_LINK_EXPIRY_MINUTES="15"

# Nota: Estudantes n√£o precisam ser configurados aqui
# Eles s√£o automaticamente autorizados se tiverem telefone cadastrado no sistema
```

### 2. Depend√™ncias

As depend√™ncias necess√°rias j√° est√£o inclu√≠das no projeto:

```json
{
  "whatsapp-web.js": "^1.23.0",
  "qrcode-terminal": "^0.12.0"
}
```

### 3. Estrutura de Arquivos

```
src/
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îú‚îÄ‚îÄ whatsapp.ts              # Classe principal WhatsApp
‚îÇ   ‚îú‚îÄ‚îÄ message-queue.ts         # Sistema de filas
‚îÇ   ‚îú‚îÄ‚îÄ whatsapp-logger.ts       # Sistema de logs
‚îÇ   ‚îî‚îÄ‚îÄ auth.ts                  # Fun√ß√µes de autoriza√ß√£o
‚îú‚îÄ‚îÄ app/api/whatsapp/
‚îÇ   ‚îú‚îÄ‚îÄ status/route.ts          # Status e controle da conex√£o
‚îÇ   ‚îú‚îÄ‚îÄ settings/route.ts        # Configura√ß√µes
‚îÇ   ‚îú‚îÄ‚îÄ send/route.ts           # Envio de mensagens
‚îÇ   ‚îî‚îÄ‚îÄ magic-link/route.ts     # Login via WhatsApp
‚îî‚îÄ‚îÄ app/admin/
    ‚îú‚îÄ‚îÄ whatsapp/page.tsx       # Interface de administra√ß√£o
    ‚îî‚îÄ‚îÄ settings/page.tsx       # Configura√ß√µes gerais
```

## üîê Autentica√ß√£o WhatsApp

### 1. Processo de Conex√£o

1. **Habilita√ß√£o**: Ative a integra√ß√£o na p√°gina de configura√ß√µes
2. **QR Code**: O sistema gera um QR Code para autentica√ß√£o
3. **Escaneamento**: Use o WhatsApp do celular para escanear o c√≥digo
4. **Conex√£o**: O sistema estabelece a conex√£o e salva a sess√£o

### 2. Interface de Administra√ß√£o

Acesse `/admin/whatsapp` para:

- ‚úÖ Habilitar/desabilitar a integra√ß√£o
- üì± Visualizar status da conex√£o
- üîÑ Verificar ou reiniciar a conex√£o
- üìä Ver estat√≠sticas de mensagens
- ‚öôÔ∏è Configurar rate limiting

### 3. Estados da Conex√£o

- **üî¥ Desconectado**: WhatsApp n√£o conectado
- **üü° Conectando**: Estabelecendo conex√£o
- **üü¢ Conectado**: Pronto para enviar mensagens
- **‚ùå Erro**: Problema na conex√£o

## üöÄ Funcionalidades

### 1. Envio de Mensagens

```typescript
// Envio direto via API
const response = await fetch('/api/whatsapp/send', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    phoneNumber: '+5511999999999',
    message: 'Sua aula est√° confirmada para hoje √†s 19h!',
    messageType: 'aula'
  })
});
```

### 2. Templates de Mensagem

O sistema suporta diferentes tipos de mensagem:

- **`aula`**: Lembretes de aulas regulares
- **`mentoria`**: Confirma√ß√µes de mentorias
- **`reposicao`**: Notifica√ß√µes de aulas de reposi√ß√£o
- **`general`**: Mensagens gerais

### 3. Sistema de Placeholders

```typescript
// Exemplo de template com placeholders
const template = `Ol√° {{studentName}}! 
Sua aula de {{courseName}} est√° confirmada para {{date}} √†s {{time}}.
Local: {{location}}`;

// Substitui√ß√£o autom√°tica
const message = template
  .replace('{{studentName}}', 'Jo√£o')
  .replace('{{courseName}}', 'Ingl√™s')
  .replace('{{date}}', '15/07/2025')
  .replace('{{time}}', '19:00')
  .replace('{{location}}', 'Sala 101');
```

## üîå API Endpoints

### 1. Status e Controle

```http
GET /api/whatsapp/status
```
Retorna status da conex√£o e estat√≠sticas.

```http
POST /api/whatsapp/status
Content-Type: application/json

{
  "action": "verify" | "restart"
}
```
Verifica ou reinicia a conex√£o.

### 2. Configura√ß√µes

```http
GET /api/whatsapp/settings
```
Obt√©m configura√ß√µes atuais.

```http
PUT /api/whatsapp/settings
Content-Type: application/json

{
  "enabled": true,
  "rateLimitSeconds": 30
}
```
Atualiza configura√ß√µes.

### 3. Envio de Mensagens

```http
POST /api/whatsapp/send
Content-Type: application/json

{
  "phoneNumber": "+5511999999999",
  "message": "Texto da mensagem",
  "messageType": "aula"
}
```

### 4. Magic Link

```http
POST /api/whatsapp/magic-link
Content-Type: application/json

{
  "phoneNumber": "+5511999999999"
}
```
Envia link de login via WhatsApp.

## üóÑÔ∏è Banco de Dados

### 1. Tabelas Principais

#### WhatsAppSettings
```sql
CREATE TABLE whatsapp_settings (
  id TEXT PRIMARY KEY,
  enabled BOOLEAN DEFAULT FALSE,
  session_data TEXT,           -- Dados da sess√£o criptografados
  qr_code TEXT,               -- QR Code atual
  is_authenticated BOOLEAN DEFAULT FALSE,
  phone_number TEXT,          -- N√∫mero conectado
  last_connection_check DATETIME,
  rate_limit_seconds INTEGER DEFAULT 30,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

#### WhatsAppMessage
```sql
CREATE TABLE whatsapp_messages (
  id TEXT PRIMARY KEY,
  recipient_phone TEXT NOT NULL,
  message_text TEXT NOT NULL,
  message_id TEXT,            -- ID do WhatsApp
  message_type TEXT,          -- aula, mentoria, reposicao
  sent_at DATETIME,
  delivery_status TEXT DEFAULT 'pending', -- pending, sent, delivered, failed
  error_message TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

#### MessageQueue
```sql
CREATE TABLE message_queue (
  id TEXT PRIMARY KEY,
  recipient_phone TEXT NOT NULL,
  message_text TEXT NOT NULL,
  message_type TEXT,
  priority INTEGER DEFAULT 3,  -- 1=alta, 5=baixa
  scheduled_for DATETIME NOT NULL,
  attempts INTEGER DEFAULT 0,
  max_attempts INTEGER DEFAULT 3,
  status TEXT DEFAULT 'pending', -- pending, processing, sent, failed, cancelled
  sent_at DATETIME,
  last_attempt_at DATETIME,
  error_message TEXT,
  metadata TEXT,              -- JSON com dados extras
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

#### WhatsAppLog
```sql
CREATE TABLE whatsapp_logs (
  id TEXT PRIMARY KEY,
  level TEXT NOT NULL,        -- debug, info, warn, error, critical
  event_type TEXT NOT NULL,   -- connection_established, message_sent, etc.
  message TEXT NOT NULL,
  metadata TEXT,              -- JSON com dados extras
  error_message TEXT,
  error_stack TEXT,
  user_id TEXT,
  phone_number TEXT,
  message_id TEXT,
  timestamp DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

## üì¨ Sistema de Filas

### 1. Funcionamento

O sistema de filas processa mensagens de forma ass√≠ncrona:

1. **Enfileiramento**: Mensagens s√£o adicionadas √† fila
2. **Processamento**: Worker processa mensagens pendentes
3. **Rate Limiting**: Respeita intervalo entre envios
4. **Retry**: Tenta reenviar mensagens falhadas
5. **Logging**: Registra todas as atividades

### 2. Configura√ß√£o da Fila

```typescript
// Adicionar mensagem √† fila
await messageQueue.enqueue({
  recipientPhone: '+5511999999999',
  messageText: 'Sua aula est√° confirmada!',
  messageType: 'aula',
  priority: 1,                    // Alta prioridade
  scheduledFor: new Date(),       // Enviar agora
  maxAttempts: 3,                 // M√°ximo 3 tentativas
  metadata: {
    studentId: 'student123',
    lessonId: 'lesson456'
  }
});
```

### 3. Worker de Processamento

O worker roda automaticamente e:

- ‚úÖ Verifica se WhatsApp est√° conectado
- ‚è∞ Respeita rate limiting
- üîÑ Processa mensagens por prioridade
- üìù Atualiza status das mensagens
- üö® Registra erros e falhas

## ‚è±Ô∏è Rate Limiting

### 1. Configura√ß√£o

- **Padr√£o**: 30 segundos entre mensagens
- **Configur√°vel**: Via interface de administra√ß√£o
- **Por Destinat√°rio**: Controle individual por n√∫mero

### 2. Funcionamento

```typescript
// Verifica√ß√£o de rate limit
const rateLimitInfo = checkRateLimit(phoneNumber);
if (!rateLimitInfo.canSend) {
  const waitTime = Math.ceil(rateLimitInfo.remainingTime / 1000);
  throw new Error(`Rate limit atingido. Aguarde ${waitTime} segundos.`);
}

// Atualiza√ß√£o ap√≥s envio
updateRateLimit(phoneNumber);
```

### 3. Bypass para Emerg√™ncias

Mensagens com prioridade 1 podem ter rate limiting reduzido para situa√ß√µes urgentes.

## üîë Magic Link via WhatsApp

### 1. Configura√ß√£o de Telefones Autorizados

```env
# Super administrador
SUPER_ADMIN_PHONE="+5511999999999"

# Administradores (separados por v√≠rgula)
ADMIN_PHONES="+5511888888888,+5511777777777,+5511666666666"
```

### 2. Processo de Login

1. **Solicita√ß√£o**: Usu√°rio informa n√∫mero de telefone
2. **Valida√ß√£o**: Sistema verifica se n√∫mero est√° autorizado
3. **Cria√ß√£o de Usu√°rio**: Se n√£o existir, cria perfil automaticamente
4. **Gera√ß√£o de Token**: Cria token de acesso tempor√°rio
5. **Envio**: Envia link via WhatsApp
6. **Login**: Usu√°rio clica no link e √© autenticado

### 3. Formato da Mensagem

```
üîê VoxStudent - Link de Acesso

Ol√°! Voc√™ solicitou acesso ao VoxStudent.

Clique no link abaixo para fazer login:
https://app.voxstudent.com/auth/verify?token=abc123

‚è∞ Este link expira em 15 minutos.

Se voc√™ n√£o solicitou este acesso, pode ignorar esta mensagem com seguran√ßa.

¬© 2025 VoxStudent - Sistema de Gest√£o Educacional
```

### 4. Seguran√ßa

- ‚úÖ Administradores e estudantes cadastrados podem solicitar login
- ‚è∞ Tokens expiram em 15 minutos (configur√°vel)
- üîí Tokens s√£o √∫nicos e de uso √∫nico
- üì± Valida√ß√£o de formato de telefone
- üö´ Rate limiting para tentativas de login

### 5. Autoriza√ß√£o de Usu√°rios

O sistema permite login via WhatsApp para:

#### üë®‚Äçüíº **Administradores**
- N√∫meros configurados em `SUPER_ADMIN_PHONE` (super administrador)
- N√∫meros configurados em `ADMIN_PHONES` (administradores)
- Recebem role `super_admin` ou `admin` automaticamente

#### üéì **Estudantes**
- Estudantes com telefone cadastrado no sistema
- Status deve ser `active` no banco de dados
- Recebem role `student` automaticamente
- Nome √© obtido do cadastro do estudante

#### ‚ùå **N√£o Autorizados**
- N√∫meros n√£o cadastrados como admin ou estudante
- Estudantes com status `inactive`
- N√∫meros com formato inv√°lido

## üìä Logs e Monitoramento

### 1. Tipos de Log

- **`debug`**: Informa√ß√µes detalhadas de desenvolvimento
- **`info`**: Eventos normais do sistema
- **`warn`**: Situa√ß√µes que requerem aten√ß√£o
- **`error`**: Erros que n√£o impedem funcionamento
- **`critical`**: Erros graves que afetam o sistema

### 2. Eventos Monitorados

- **`connection_established`**: Conex√£o WhatsApp estabelecida
- **`connection_lost`**: Perda de conex√£o
- **`message_sent`**: Mensagem enviada com sucesso
- **`message_failed`**: Falha no envio
- **`rate_limit_hit`**: Rate limit atingido
- **`qr_code_generated`**: QR Code gerado
- **`authentication_success`**: Autentica√ß√£o bem-sucedida

### 3. Consulta de Logs

```typescript
// Buscar logs por tipo de evento
const logs = await prisma.whatsAppLog.findMany({
  where: {
    eventType: 'message_sent',
    timestamp: {
      gte: new Date(Date.now() - 24 * 60 * 60 * 1000) // √öltimas 24h
    }
  },
  orderBy: { timestamp: 'desc' }
});
```

## üîß Troubleshooting

### 1. Problemas Comuns

#### WhatsApp n√£o conecta
```bash
# Verificar logs
tail -f logs/whatsapp.log

# Limpar sess√£o
rm -rf whatsapp-session/
```

#### Mensagens n√£o s√£o enviadas
1. ‚úÖ Verificar se WhatsApp est√° conectado
2. ‚úÖ Confirmar rate limiting
3. ‚úÖ Validar formato do telefone
4. ‚úÖ Verificar logs de erro

#### QR Code n√£o aparece
1. ‚úÖ Verificar se integra√ß√£o est√° habilitada
2. ‚úÖ Reiniciar servi√ßo WhatsApp
3. ‚úÖ Limpar cache do navegador
4. ‚úÖ Verificar se o QR Code est√° sendo salvo no banco:
   ```sql
   SELECT qr_code FROM whatsapp_settings WHERE id = 'default';
   ```
5. ‚úÖ Verificar logs do WhatsApp para erros de gera√ß√£o

### 2. Comandos √öteis

```bash
# Verificar status da conex√£o
curl -X GET http://localhost:3000/api/whatsapp/status \
  -H "Authorization: Bearer YOUR_TOKEN"

# Enviar mensagem de teste
curl -X POST http://localhost:3000/api/whatsapp/send \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "phoneNumber": "+5511999999999",
    "message": "Teste de conex√£o WhatsApp"
  }'

# Verificar fila de mensagens
curl -X GET http://localhost:3000/api/queue \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 3. Logs de Debug

Para ativar logs detalhados, defina a vari√°vel de ambiente:

```env
DEBUG_WHATSAPP=true
```

### 4. Monitoramento de Performance

```typescript
// Estat√≠sticas de performance
const stats = await prisma.whatsAppMessage.groupBy({
  by: ['deliveryStatus'],
  _count: true,
  where: {
    createdAt: {
      gte: new Date(Date.now() - 24 * 60 * 60 * 1000)
    }
  }
});

console.log('Estat√≠sticas 24h:', stats);
// Resultado: [
//   { deliveryStatus: 'sent', _count: 45 },
//   { deliveryStatus: 'failed', _count: 2 },
//   { deliveryStatus: 'pending', _count: 1 }
// ]
```

## üìù Notas Importantes

1. **Sess√£o WhatsApp**: A sess√£o √© salva localmente em `whatsapp-session/`
2. **Backup**: Fa√ßa backup da pasta de sess√£o para evitar reconex√µes
3. **Produ√ß√£o**: Use PM2 ou similar para manter o processo ativo
4. **Seguran√ßa**: Nunca exponha tokens ou dados de sess√£o
5. **Rate Limiting**: Respeite os limites para evitar bloqueios
6. **Monitoramento**: Monitore logs regularmente para detectar problemas

## üîó Links √öteis

- [whatsapp-web.js Documentation](https://wwebjs.dev/)
- [WhatsApp Business API](https://developers.facebook.com/docs/whatsapp)
- [Puppeteer Documentation](https://pptr.dev/)

---

**Desenvolvido para VoxStudent** üìö‚ú®
